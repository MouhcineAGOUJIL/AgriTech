<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriTech Monitor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Icons (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: white; 
            min-height: 100vh;
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .glow-green { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
        .glow-blue { box-shadow: 0 0 20rgba(59, 130, 246, 0.4); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .float { animation: float 3s ease-in-out infinite; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fan-spin { animation: spin 2s linear infinite; }
        
        @keyframes drip { 
            0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(10px) scale(0.8); opacity: 0.7; }
        }
        .water-drip { animation: drip 1.5s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Cards
        const Card = ({ title, value, unit, icon, status, type, trend }) => {
            let statusColor = "text-gray-400";
            if(type === "temp") {
                statusColor = value > 30 ? "text-red-500" : "text-emerald-400";
            }
            if(type === "humid") {
                statusColor = value < 40 ? "text-blue-400" : "text-emerald-400";
            }

            return (
                <div className="glass rounded-xl p-6 flex flex-col items-center justify-between shadow-lg transition-all duration-500 hover:scale-105">
                    <div className="flex items-center justify-between w-full mb-4">
                        <h3 className="text-gray-400 text-sm font-bold uppercase tracking-wider">{title}</h3>
                        <i className={`ph ${icon} text-2xl ${statusColor} float`}></i>
                    </div>
                    <div className="text-5xl font-bold mb-2">
                        {value}<span className="text-xl text-gray-500 ml-1">{unit}</span>
                    </div>
                    <div className="flex items-center gap-2 mb-2">
                        {trend > 0 ? (
                            <i className="ph ph-trend-up text-green-400"></i>
                        ) : trend < 0 ? (
                            <i className="ph ph-trend-down text-red-400"></i>
                        ) : (
                            <i className="ph ph-equals text-gray-400"></i>
                        )}
                        <span className="text-xs text-gray-400">{Math.abs(trend).toFixed(1)} from avg</span>
                    </div>
                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${status ? 'bg-green-900 text-green-300' : 'bg-slate-700 text-slate-400'}`}>
                        {status ? "ACTIVE" : "STANDBY"}
                    </div>
                </div>
            );
        };

        // Device card
        const DeviceCard = ({ name, isOn, iconOn, iconOff, power }) => (
            <div className={`rounded-xl p-4 flex items-center justify-between border transition-all duration-500 ${isOn ? 'bg-slate-800 border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.3)]' : 'bg-slate-900 border-slate-700 opacity-60'}`}>
                <div className="flex items-center gap-3">
                    <div className={`p-3 rounded-lg ${isOn ? 'bg-green-900 text-green-400' : 'bg-slate-800 text-slate-500'}`}>
                        <i className={`ph ${isOn ? iconOn : iconOff} text-2xl`}></i>
                    </div>
                    <div>
                        <h4 className="font-bold text-lg">{name}</h4>
                        <p className="text-xs text-gray-400">{isOn ? `${power}W` : "Idle"}</p>
                    </div>
                </div>
                <div className={`h-3 w-3 rounded-full ${isOn ? 'bg-green-500 animate-pulse' : 'bg-slate-600'}`}></div>
            </div>
        );

        // Alerts
        const AlertBanner = ({ alerts }) => {
            if (!alerts.length) return null;
            
            return (
                <div className="mb-6 space-y-2">
                    {alerts.map((alert, i) => (
                        <div key={i} className={`p-4 rounded-lg border flex items-center gap-3 ${
                            alert.type === 'warning' ? 'bg-yellow-900/20 border-yellow-500/50 text-yellow-300' :
                            alert.type === 'danger' ? 'bg-red-900/20 border-red-500/50 text-red-300' :
                            'bg-blue-900/20 border-blue-500/50 text-blue-300'
                        }`}>
                            <i className={`ph ${alert.icon} text-2xl`}></i>
                            <div className="flex-1">
                                <p className="font-bold">{alert.title}</p>
                                <p className="text-xs opacity-80">{alert.message}</p>
                            </div>
                            <span className="text-xs opacity-60">{alert.time}</span>
                        </div>
                    ))}
                </div>
            );
        };

        // Stats
        const StatsPanel = ({ stats }) => (
            <div className="glass rounded-xl p-6">
                <h3 className="text-gray-400 text-sm font-bold uppercase mb-4">Daily Statistics</h3>
                <div className="grid grid-cols-2 gap-4">
                    <div className="text-center p-4 bg-slate-800/50 rounded-lg">
                        <p className="text-xs text-gray-400 mb-1">Avg Temp</p>
                        <p className="text-2xl font-bold text-orange-400">{stats.avgTemp}Â°C</p>
                    </div>
                    <div className="text-center p-4 bg-slate-800/50 rounded-lg">
                        <p className="text-xs text-gray-400 mb-1">Avg Humid</p>
                        <p className="text-2xl font-bold text-blue-400">{stats.avgHumid}%</p>
                    </div>
                    <div className="text-center p-4 bg-slate-800/50 rounded-lg">
                        <p className="text-xs text-gray-400 mb-1">Water Used</p>
                        <p className="text-2xl font-bold text-cyan-400">{stats.waterUsed.toFixed(1)}L</p>
                    </div>
                    <div className="text-center p-4 bg-slate-800/50 rounded-lg">
                        <p className="text-xs text-gray-400 mb-1">Uptime</p>
                        <p className="text-2xl font-bold text-green-400">{stats.uptime}h</p>
                    </div>
                </div>
            </div>
        );

        // Main App
        const App = () => {
            const [data, setData] = useState({ temp: 0, humid: 0, fan: false, pump: false, status: "Connecting..." });
            const [history, setHistory] = useState({ labels: [], temp: [], humid: [] });
            const [alerts, setAlerts] = useState([]);
            const [stats, setStats] = useState({ avgTemp: 0, avgHumid: 0, waterUsed: 0, uptime: 0 });

            const chartRef = useRef(null);

            // Fetch loop
            useEffect(() => {
                const interval = setInterval(async () => {
                    try {
                        const response = await fetch('http://localhost:5000/api/data');
                        const json = await response.json();
                        setData(json);

                        const now = new Date().toLocaleTimeString();
                        setHistory(prev => {
                            const newLabels = [...prev.labels, now].slice(-20);
                            const newTemp = [...prev.temp, json.temp].slice(-20);
                            const newHumid = [...prev.humid, json.humid].slice(-20);

                            const avgT = (newTemp.reduce((a,b) => a+b, 0) / newTemp.length).toFixed(1);
                            const avgH = (newHumid.reduce((a,b) => a+b, 0) / newHumid.length).toFixed(1);

                            setStats(prev => ({
                                avgTemp: avgT,
                                avgHumid: avgH,
                                waterUsed: prev.waterUsed + (json.pump ? 0.1 : 0),
                                uptime: (Date.now() / 3600000).toFixed(1)
                            }));

                            return { labels: newLabels, temp: newTemp, humid: newHumid };
                        });

                        // Alerts
                        const newAlerts = [];
                        if (json.temp > 32) {
                            newAlerts.push({
                                type: 'danger',
                                icon: 'ph-warning',
                                title: 'High Temperature Alert',
                                message: `Temperature reached ${json.temp}Â°C`,
                                time: new Date().toLocaleTimeString()
                            });
                        }
                        if (json.humid < 35) {
                            newAlerts.push({
                                type: 'warning',
                                icon: 'ph-drop',
                                title: 'Low Humidity Warning',
                                message: `Humidity at ${json.humid}%`,
                                time: new Date().toLocaleTimeString()
                            });
                        }
                        setAlerts(newAlerts);

                    } catch (error) {
                        console.error("Connection Error", error);
                        setData(prev => ({ ...prev, status: "Error" }));
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // Chart
            useEffect(() => {
                if (!chartRef.current) return;
                const ctx = chartRef.current.getContext('2d');
                if (window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.labels,
                        datasets: [
                            {
                                label: 'Temperature (Â°C)',
                                data: history.temp,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Humidity (%)',
                                data: history.humid,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: 'white' } },
                            x: { ticks: { display: false } }
                        }
                    }
                });
            }, [history]);

            const tempTrend = history.temp.length > 1 ? 
                data.temp - (history.temp.reduce((a,b) => a+b, 0) / history.temp.length) : 0;

            const humidTrend = history.humid.length > 1 ? 
                data.humid - (history.humid.reduce((a,b) => a+b, 0) / history.humid.length) : 0;

            return (
                <div className="min-h-screen p-8 max-w-6xl mx-auto">

                    {/* Header */}
                    <header className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-400 via-emerald-500 to-teal-600">
                                ðŸŒ¿ Smart AgriTech
                            </h1>
                            <p className="text-slate-400 text-sm mt-1">Real-time Environmental Monitor</p>
                        </div>

                        <div className={`px-4 py-2 rounded-lg border ${data.status === "Online" ? 'bg-green-500/10 border-green-500/50 text-green-400' : 'bg-red-500/10 border-red-500/50 text-red-400'}`}>
                            <i className="ph ph-wifi-high mr-2"></i>
                            {data.status}
                        </div>
                    </header>

                    <AlertBanner alerts={alerts} />

                    {/* Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <Card 
                            title="Temperature" 
                            value={data.temp} 
                            unit="Â°C" 
                            icon="ph-thermometer" 
                            type="temp"
                            status={data.fan}
                            trend={tempTrend}
                        />
                        <Card 
                            title="Humidity" 
                            value={data.humid} 
                            unit="%" 
                            icon="ph-drop" 
                            type="humid"
                            status={data.pump}
                            trend={humidTrend}
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        
                        <div className="lg:col-span-2 glass rounded-xl p-6">
                            <div className="relative h-64 w-full">
                                <canvas ref={chartRef}></canvas>
                            </div>
                        </div>

                        <div className="flex flex-col gap-4">
                            <h3 className="text-gray-400 text-sm font-bold uppercase">System Status</h3>
                            
                            <DeviceCard 
                                name="Cooling Fan" 
                                isOn={data.fan} 
                                iconOn="ph-fan ph-spin" 
                                iconOff="ph-fan"
                                power="45"
                            />
                            
                            <DeviceCard 
                                name="Irrigation Pump" 
                                isOn={data.pump} 
                                iconOn="ph-waves" 
                                iconOff="ph-drop-slash"
                                power="120"
                            />

                            <div className="mt-auto p-4 rounded-xl bg-gradient-to-br from-slate-900 to-slate-800 border border-slate-700 text-center">
                                <p className="text-xs text-gray-500 mb-1">Server Connection</p>
                                <p className="text-sm font-mono text-blue-400">localhost:5000</p>
                                <div className="mt-2 flex items-center justify-center gap-2">
                                    <div className="h-2 w-2 rounded-full bg-green-500 animate-pulse"></div>
                                    <span className="text-xs text-green-400">Connected</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <StatsPanel stats={stats} />
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
</body>
</html>
